<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©initialiser votre mot de passe - LIBUK</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007AFF;
            --secondary: #8B5CF6;
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --bg-surface: #F9FAFB;
            --bg-card: #FFFFFF;
            --border: #E5E7EB;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3B82F6;
                --secondary: #A78BFA;
                --text-primary: #F9FAFB;
                --text-secondary: #D1D5DB;
                --bg-surface: #111827;
                --bg-card: #1F2937;
                --border: #374151;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-width: 480px;
            width: 100%;
            padding: 48px 40px;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-container {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .logo svg {
            width: 48px;
            height: 48px;
            color: white;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 14px 48px 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-surface);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .toggle-password:hover {
            color: var(--primary);
        }

        .password-strength {
            margin-top: 12px;
            display: none;
        }

        .password-strength.visible {
            display: block;
        }

        .strength-bars {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .strength-bar {
            height: 4px;
            flex: 1;
            background: var(--border);
            border-radius: 2px;
            transition: background 0.3s ease;
        }

        .strength-bar.active {
            background: var(--error);
        }

        .strength-bar.active.medium {
            background: var(--warning);
        }

        .strength-bar.active.strong {
            background: var(--success);
        }

        .strength-text {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .strength-text.weak { color: var(--error); }
        .strength-text.medium { color: var(--warning); }
        .strength-text.strong { color: var(--success); }

        .error-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            color: var(--error);
            font-size: 14px;
            margin-top: 12px;
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .success-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            color: var(--success);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 122, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--border);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--bg-surface);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .footer {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .footer-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .footer-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 640px) {
            body {
                padding: 16px;
            }
            
            .container {
                padding: 32px 24px;
                border-radius: 20px;
            }

            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }
            
            .logo {
                width: 64px;
                height: 64px;
            }
            
            .logo svg {
                width: 36px;
                height: 36px;
            }
            
            input[type="password"],
            input[type="text"] {
                font-size: 16px; /* Emp√™che le zoom automatique sur iOS */
                padding: 12px 44px 12px 14px;
            }
            
            .btn {
                padding: 14px;
                font-size: 15px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
        }
        
        @media (max-width: 380px) {
            .container {
                padding: 24px 20px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .logo {
                width: 56px;
                height: 56px;
            }
            
            .logo svg {
                width: 32px;
                height: 32px;
            }
        }
        
        /* Paysage sur mobile */
        @media (max-height: 600px) and (orientation: landscape) {
            .container {
                padding: 24px;
                margin: 20px auto;
            }
            
            .logo-container {
                margin-bottom: 20px;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5"></path>
                    <path d="M2 12l10 5 10-5"></path>
                </svg>
            </div>
            <h1>LIBUK</h1>
            <p class="subtitle">R√©initialisez votre mot de passe</p>
        </div>

        <!-- Formulaire de r√©initialisation -->
        <form id="resetForm">
            <div class="form-group">
                <label for="newPassword">Nouveau mot de passe</label>
                <div class="input-wrapper">
                    <input 
                        type="password" 
                        id="newPassword" 
                        placeholder="Au moins 8 caract√®res"
                        required
                        minlength="8"
                    >
                    <button type="button" class="toggle-password" data-target="newPassword">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <div class="password-strength" id="passwordStrength">
                    <div class="strength-bars">
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                    </div>
                    <div class="strength-text" id="strengthText">
                        <span id="strengthLabel">Faible</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirmer le mot de passe</label>
                <div class="input-wrapper">
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        placeholder="Retapez votre mot de passe"
                        required
                        minlength="8"
                    >
                    <button type="button" class="toggle-password" data-target="confirmPassword">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <div class="error-message hidden" id="passwordError">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span>Les mots de passe ne correspondent pas</span>
                </div>
            </div>

            <div class="error-message hidden" id="errorMessage"></div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span id="submitText">R√©initialiser le mot de passe</span>
                <div class="spinner hidden" id="spinner"></div>
            </button>
        </form>

        <!-- Message de succ√®s -->
        <div class="success-message hidden" id="successMessage">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <div>
                <strong>Mot de passe mis √† jour !</strong><br>
                <span style="font-size: 13px;">Redirection vers l'application...</span>
            </div>
        </div>

        <button class="btn btn-secondary hidden" id="openAppBtn">
            Ouvrir l'application LIBUK
        </button>

        <div class="footer">
            <p class="footer-text">
                ¬© 2026 LIBUK - GENESIS LABS<br>
                <a href="mailto:contact@genesislabs.fr" class="footer-link">contact@genesislabs.fr</a>
            </p>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://lolcsnyixdagrnovviin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvbGNzbnlpeGRhZ3Jub3Z2aWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMjk0NDUsImV4cCI6MjA2ODgwNTQ0NX0.G6gvriB1tgcP0Ahhu-2qZgk-CoLbGIcZg1IDyj_M9Cs';

        // √âl√©ments DOM
        const form = document.getElementById('resetForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const passwordError = document.getElementById('passwordError');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const spinner = document.getElementById('spinner');
        const openAppBtn = document.getElementById('openAppBtn');
        const passwordStrength = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        const strengthLabel = document.getElementById('strengthLabel');
        const strengthBars = document.querySelectorAll('.strength-bar');

        // Extraire le token de l'URL
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get('access_token');
        const type = urlParams.get('type');
        const expiresAt = urlParams.get('expires_at');
        const expiresIn = urlParams.get('expires_in');
        
        // Mode debug : permet de tester la page sans token (√† retirer en production)
        const debugMode = urlParams.get('debug') === 'true' || window.location.search.includes('debug=true');

        // V√©rifier l'expiration du token
        function isTokenExpired() {
            if (expiresAt) {
                const expiryTime = parseInt(expiresAt) * 1000;
                return Date.now() > expiryTime;
            }
            return false;
        }

        // V√©rifier que c'est bien une r√©initialisation de mot de passe
        if ((!accessToken || type !== 'recovery') && !debugMode) {
            errorMessage.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg><span>‚ö†Ô∏è Lien de r√©initialisation invalide ou expir√©.<br><small>Retournez dans l\'application et demandez un nouveau lien de r√©initialisation.</small></span>';
            errorMessage.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            
            // Afficher un bouton pour revenir √† l'app
            openAppBtn.textContent = 'Retour √† l\'application';
            openAppBtn.classList.remove('hidden');
            openAppBtn.onclick = function() {
                window.location.href = 'libuk://auth/forgot-password';
            };
        } else if (isTokenExpired() && !debugMode) {
            errorMessage.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v6m0 4v8m0 0l-3-3m3 3l3-3"></path></svg><span>‚è∞ Ce lien a expir√©.<br><small>Les liens de r√©initialisation sont valables 1 heure. Demandez un nouveau lien.</small></span>';
            errorMessage.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            
            // Afficher un bouton pour revenir √† l'app
            openAppBtn.textContent = 'Demander un nouveau lien';
            openAppBtn.classList.remove('hidden');
            openAppBtn.onclick = function() {
                window.location.href = 'libuk://auth/forgot-password';
            };
        }
        
        // Afficher le temps restant
        if (accessToken && type === 'recovery' && !isTokenExpired() && expiresIn) {
            const minutes = Math.floor(parseInt(expiresIn) / 60);
            if (minutes < 10) {
                const timeWarning = document.createElement('div');
                timeWarning.style.cssText = 'background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--warning); padding: 12px; border-radius: 12px; margin-bottom: 16px; font-size: 13px; text-align: center;';
                timeWarning.innerHTML = `‚è∞ Ce lien expire dans ${minutes} minute${minutes > 1 ? 's' : ''}`;
                form.insertAdjacentElement('beforebegin', timeWarning);
            }
        }
        
        // Afficher un warning si en mode debug
        if (debugMode) {
            console.log('‚ö†Ô∏è MODE DEBUG ACTIV√â - La requ√™te API ne fonctionnera pas sans vrai token');
            const debugWarning = document.createElement('div');
            debugWarning.style.cssText = 'background: #FEF3C7; border: 1px solid #F59E0B; color: #92400E; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;';
            debugWarning.innerHTML = '‚ö†Ô∏è <strong>Mode Debug</strong> - Pour tester avec un vrai token, ajoutez <code>?debug=true</code> √† l\'URL';
            document.getElementById('resetForm').insertAdjacentElement('beforebegin', debugWarning);
        }

        // Toggle visibility du mot de passe
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                
                // Changer l'ic√¥ne
                const svg = this.querySelector('svg');
                if (type === 'text') {
                    svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
                } else {
                    svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
                }
            });
        });

        // Calculer la force du mot de passe
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            
            if (password.length === 0) {
                passwordStrength.classList.remove('visible');
                return;
            }
            
            passwordStrength.classList.add('visible');
            
            let strength = 0;
            
            // Crit√®res de force
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            // D√©terminer le niveau (1 = faible, 2 = moyen, 3 = fort)
            let level = 1; // Par d√©faut faible
            if (strength >= 5) {
                level = 3; // Fort
            } else if (strength >= 3) {
                level = 2; // Moyen
            }
            
            // Mettre √† jour les barres
            strengthBars.forEach((bar, index) => {
                // Retirer toutes les classes
                bar.classList.remove('active', 'medium', 'strong');
                
                // Ajouter les classes appropri√©es
                if (index < level) {
                    bar.classList.add('active');
                    if (level === 2) {
                        bar.classList.add('medium');
                    } else if (level === 3) {
                        bar.classList.add('strong');
                    }
                }
            });
            
            // Mettre √† jour le texte
            strengthText.className = 'strength-text';
            if (level === 1) {
                strengthText.classList.add('weak');
                strengthLabel.textContent = 'Faible';
            } else if (level === 2) {
                strengthText.classList.add('medium');
                strengthLabel.textContent = 'Moyen';
            } else {
                strengthText.classList.add('strong');
                strengthLabel.textContent = 'Fort';
            }
            
            // V√©rifier si le formulaire est valide pour activer/d√©sactiver le bouton
            validateForm();
        });

        // V√©rifier que les mots de passe correspondent
        confirmPasswordInput.addEventListener('input', function() {
            if (this.value && this.value !== newPasswordInput.value) {
                passwordError.classList.remove('hidden');
            } else {
                passwordError.classList.add('hidden');
            }
            
            // V√©rifier si le formulaire est valide
            validateForm();
        });
        
        // Fonction de validation du formulaire
        function validateForm() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const isValid = newPassword.length >= 8 && 
                           newPassword === confirmPassword && 
                           (accessToken || debugMode);
            
            submitBtn.disabled = !isValid;
            submitBtn.style.opacity = isValid ? '1' : '0.6';
            submitBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
        }

        // Soumettre le formulaire
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            // Validation
            if (newPassword.length < 8) {
                showError('Le mot de passe doit contenir au moins 8 caract√®res');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('Les mots de passe ne correspondent pas');
                return;
            }
            
            // D√©sactiver le bouton et afficher le spinner
            submitBtn.disabled = true;
            submitText.textContent = 'Mise √† jour...';
            spinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            try {
                // Appel API Supabase pour mettre √† jour le mot de passe
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        password: newPassword
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erreur lors de la mise √† jour du mot de passe');
                }
                
                // Succ√®s !
                form.classList.add('hidden');
                successMessage.classList.remove('hidden');
                openAppBtn.classList.remove('hidden');
                
                // Redirection automatique apr√®s 2 secondes
                setTimeout(() => {
                    window.location.href = 'libuk://auth/success';
                }, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                
                // D√©tection d'erreurs sp√©cifiques
                let errorMsg = error.message || 'Une erreur est survenue.';
                
                if (errorMsg.includes('expired') || errorMsg.includes('invalid') || errorMsg.includes('401')) {
                    errorMsg = '‚è∞ Ce lien a expir√©. Retournez dans l\'application et demandez un nouveau lien de r√©initialisation.';
                    
                    // D√©sactiver le formulaire
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    newPasswordInput.disabled = true;
                    confirmPasswordInput.disabled = true;
                    
                    // Afficher bouton pour retour app
                    openAppBtn.textContent = 'Retour √† l\'application';
                    openAppBtn.classList.remove('hidden');
                    openAppBtn.onclick = function() {
                        window.location.href = 'libuk://auth/forgot-password';
                    };
                } else if (errorMsg.includes('weak')) {
                    errorMsg = 'üîí Mot de passe trop faible. Utilisez au moins 8 caract√®res avec majuscules, minuscules et chiffres.';
                }
                
                showError(errorMsg);
                
                if (!submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitText.textContent = 'R√©initialiser le mot de passe';
                    spinner.classList.add('hidden');
                }
            }
        });

        // Bouton pour ouvrir l'app manuellement
        openAppBtn.addEventListener('click', function() {
            window.location.href = 'libuk://auth/success';
        });

        // Fonction pour afficher les erreurs
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
